<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Binaural FIR Example</title>
        <meta charset="utf-8"/>
        <script src="../include/AudioContextMonkeyPatch.js"></script>
        <script src="../binaural.js"></script>
        <script src="./js/jquery-1.11.1.min.js"></script>
        <script src="./js/jquery.knob.js"></script>
        <style type="text/css">
         input[type=range][orient=vertical]
         {
             writing-mode: bt-lr; /* IE */
             -webkit-appearance: slider-vertical; /* WebKit */
             width: 8px;
             height: 175px;
             padding: 0 5px;
         }
        </style>
    </head>
    <body>
        <h1>Binaural FIR Example</h1>
        <p>
            This example illustrates the use of the binauralFIR node to spatialize in real-time an incoming monophonic audio stream around the head of the listener. The process can be easily replicated for multiple sources or multichannel audio streams. In this implementation, the binaural process simply relies on the convolution of the incoming audio stream with Head Related Impulse Responses (HRIRs) measured on a human head in free field conditions (anecho√Øc room). See [1] for implementation details and implementation alternative.
        </p>
        <p>
            The basic user interface provides control of the rotation on the horizontal plane (azimuth) and on the vertical dimension (elevation). In the current version, the set of HRIRs is imposed. In a future release, the user interface will propose to download different sets of HRIRs from a public server that will host a database of individual HRIRs.
        </p>
        <p>
            [1]  T. Carpentier, Binaural Synthesis with the Web Audio API, 1st Web Audio Conference (WAC15), Paris 2015
        </p>
        <audio id="source" src="./snd/breakbeat.wav" controls loop></audio>
        <center>
            <pre> Azimuth </pre>
            <input type="text" data-angleOffset=180 class="vs1" data-width="180" data-cursor=true data-thickness=".5"  data-min="-180" data-max="180" data-rotation="clockwise" />
            <pre> Elevation </pre>
            <input type="range" min="-90" max="90" step="0.5" class="vs3" orient="vertical" />
        </center>

        <script>
         var audioContext = new AudioContext();
         var serverDataBase = new binaural.default.sofa.ServerDataBase();
         serverDataBase
         .loadCatalogue()
         .then( function () {
             return serverDataBase.getUrls({
                 convention: 'HRIR',
                 dataBase: 'CROSSMOD',
                 equalisation: 'compensated',
                 sampleRate: audioContext.sampleRate,
                 freePattern: '1070',
             });
         })
         .then( function (urls) {
             var hrtfSet = new binaural.default.sofa.HrtfSet({
                 audioContext: audioContext,
                 positionsType: 'gl', // mandatory for BinauralPanner
             });

             return hrtfSet.load(urls[0])
         })
         .then( function (hrtfSet) {
             // Audio Nodes
             var $mediaElement = document.getElementById('source');
             var player = audioContext.createMediaElementSource($mediaElement);

             binauralPanner = new binaural.default.audio.BinauralPanner({
                 audioContext,
                 hrtfSet: hrtfSet,
                 corssfadeDuration: 0.01,
                 positionsType: 'sofaSpherical',
                 sourceCount: 1,
                 sourcePositions: [ [0, 0, 1] ],
             });

             binauralPanner.connectOutputs(audioContext.destination);
             binauralPanner.connectInputByIndex(0, player);

             // Knobs
             $(".vs1").val(0);
             $(".vs1").knob({
                 'change': function(value) {
                     var position = binauralPanner.getSourcePositionByIndex(0);
                     position[0] = -value;
                     binauralPanner.setSourcePositionByIndex(0, position);
                     window.requestAnimationFrame( function() {
                         binauralPanner.update();
                     });
                 }
             });

             $('.vs3').on("input", function(event) {
                 var position = binauralPanner.getSourcePositionByIndex(0);
                 position[1] = event.target.value;
                 binauralPanner.setSourcePositionByIndex(0, position);
                 window.requestAnimationFrame( function() {
                     binauralPanner.update();
                 });
             });

         });
        </script>
    </body>
</html>
